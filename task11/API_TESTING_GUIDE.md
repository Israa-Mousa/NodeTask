# API Testing Guide - Simple Shop Backend

## üìã Prerequisites

Before testing, ensure:
1. MySQL server is running on `localhost:3306`
2. Database credentials in `.env` are correct:
   ```
   DATABASE_URL="mysql://root:password@localhost:3306/simple_shop"
   JWT_SECRET="dev-jwt-secret-key-change-in-production-12345"
   ```
3. Dev server is running: `npm run dev`
4. Server starts at: `http://localhost:3000`

---

## üßæ Seeded Accounts (included in `seed`)

The project includes a seeder that creates test users and products. Run the seeder to insert these accounts:

```bash
npm run seed
```

Default seeded accounts you can use to test authentication and admin flows:

- **Admin**
  - Email: `admin@shop.com`
  - Password: `Password123!`

- **Merchant**
  - Email: `merchant@example.com`
  - Password: `1234567`

- **Customers**
  - 15 random customers are generated by faker (emails and passwords are random).
  - You can list users with `GET /api/user` after seeding to find a customer's email.

Notes:
- Passwords for seeded users are hashed in the database ‚Äî use the plain values above for `POST /api/auth/login` after running the seeder.
- The seeder creates merchants and products for testing product-related endpoints.


## üîê 1. Authentication

### Register User
```bash
POST http://localhost:3000/api/auth/register
Content-Type: application/json

{
  "name": "John Merichant",
  "email": "Merchant@shop.com",
  "password": "Password123!",
  "role": "MERCHANT"
}
```

### Register Customer
```bash
POST http://localhost:3000/api/auth/register
Content-Type: application/json

{
  "name": "Jane Customer",
  "email": "customer@shop.com",
  "password": "Password123!",
  "role": "CUSTOMER"
}
```

### Login
```bash
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "email": "admin@shop.com",
  "password": "Password123!"
}
```

**Response:**
```json
{
  "user": {
    "id": "1",
    "name": "John Admin",
    "email": "admin@shop.com",
    "role": "ADMIN"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

Save the `token` for subsequent requests.

---

## üë§ 2. User Management (Pagination, Sorting, Field Selection)

### Get All Users - Basic Pagination
```bash
GET http://localhost:3000/api/user?page=1&limit=10
Authorization: Bearer <your_jwt_token>
```

**Response:**
```json
{
  "data": [
    {
      "id": "1",
      "name": "John Admin",
      "email": "admin@shop.com",
      "role": "ADMIN",
      "createdAt": "2025-12-20T10:00:00.000Z"
    }
  ],
  "meta": {
    "total": 5,
    "page": 1,
    "limit": 10,
    "totalPages": 1
  }
}
```

### Get Users - Sorted by Newest
```bash
GET http://localhost:3000/api/user?page=1&limit=5&sortBy=createdAt
Authorization: Bearer <your_jwt_token>
```

### Get Users - Field Selection
```bash
GET http://localhost:3000/api/user?page=1&limit=10&fields=id,name,email,role
Authorization: Bearer <your_jwt_token>
```

Returns only selected fields (password always excluded for security).

### Get Single User
```bash
GET http://localhost:3000/api/user/1
Authorization: Bearer <your_jwt_token>
```

### Update User Profile
```bash
PATCH http://localhost:3000/api/user/1
Authorization: Bearer <your_jwt_token>
Content-Type: application/json

{
  "name": "Updated Name"
}
```

---

## üõçÔ∏è 3. Products (Pagination, Sorting, Field Selection)

### Create Product (Merchant Only)
```bash
POST http://localhost:3000/api/product
Authorization: Bearer <your_merchant_jwt_token>
Content-Type: application/json

{
  "name": "Laptop",
  "description": "High-performance laptop",
  "price": 999.99
}
```

### Get All Products - Paginated
```bash
GET http://localhost:3000/api/product?page=1&limit=10
```

### Get Products - Sorted by ID
```bash
GET http://localhost:3000/api/product?page=1&limit=10&sortBy=id
```

### Get Products - Field Selection
```bash
GET http://localhost:3000/api/product?page=1&limit=10&fields=id,name,price
```

### Search Products
```bash
GET http://localhost:3000/api/product?page=1&limit=10&name=Laptop
```

### Get Single Product
```bash
GET http://localhost:3000/api/product/1
```

---

## üì¶ 4. Orders (Pagination, Sorting, Field Selection)

### Create Order (Customer Only)
```bash
POST http://localhost:3000/api/order
Authorization: Bearer <your_customer_jwt_token>
Content-Type: application/json

[
  {
    "productId": 1,
    "qty": 2
  },
  {
    "productId": 2,
    "qty": 1
  }
]
```

**Response:**
```json
{
  "id": 1,
  "userId": "2",
  "orderStatus": "PENDING",
  "createdAt": "2025-12-20T10:00:00.000Z",
  "orderProducts": [
    {
      "productId": "1",
      "totalQty": 2,
      "pricePerItem": "999.99"
    }
  ],
  "transactions": [
    {
      "id": "1",
      "amount": "2999.97",
      "type": "DEBIT",
      "createdAt": "2025-12-20T10:00:00.000Z"
    }
  ]
}
```

### Get User's Orders - Paginated
```bash
GET http://localhost:3000/api/order?page=1&limit=10
Authorization: Bearer <your_customer_jwt_token>
```

### Get Orders - Sorted by Newest
```bash
GET http://localhost:3000/api/order?page=1&limit=10&sortBy=createdAt
Authorization: Bearer <your_customer_jwt_token>
```

### Get Orders - Field Selection
```bash
GET http://localhost:3000/api/order?page=1&limit=10&fields=id,orderStatus,createdAt
Authorization: Bearer <your_customer_jwt_token>
```

### Get Single Order Details
```bash
GET http://localhost:3000/api/order/1
Authorization: Bearer <your_customer_jwt_token>
```

---

## üí≥ 5. Transactions (Pagination, Sorting, Field Selection)

### Get User's Transactions - Paginated
```bash
GET http://localhost:3000/api/transaction?page=1&limit=10
Authorization: Bearer <your_customer_jwt_token>
```

### Get Transactions - Sorted by Newest
```bash
GET http://localhost:3000/api/transaction?page=1&limit=10&sortBy=createdAt
Authorization: Bearer <your_customer_jwt_token>
```

### Get Transactions - Field Selection
```bash
GET http://localhost:3000/api/transaction?page=1&limit=10&fields=id,amount,type,createdAt
Authorization: Bearer <your_customer_jwt_token>
```

**Response:**
```json
{
  "data": [
    {
      "id": "1",
      "amount": "2999.97",
      "type": "DEBIT",
      "createdAt": "2025-12-20T10:00:00.000Z",
      "paymentMethod": "CASH",
      "order": {
        "id": "1",
        "orderStatus": "PENDING"
      },
      "orderReturn": null
    },
    {
      "id": "2",
      "amount": "500.00",
      "type": "CREDIT",
      "createdAt": "2025-12-20T10:30:00.000Z",
      "paymentMethod": "CASH",
      "order": {
        "id": "1",
        "orderStatus": "SUCCESS"
      },
      "orderReturn": {
        "id": "1",
        "status": "REFUND"
      }
    }
  ],
  "meta": {
    "total": 2,
    "page": 1,
    "limit": 10,
    "totalPages": 1
  }
}
```

---

## üõ°Ô∏è 6. Admin Actions (ADMIN ROLE REQUIRED)

### Update Order Status (Admin Only)
```bash
POST http://localhost:3000/api/order/1/status
Authorization: Bearer <your_admin_jwt_token>
Content-Type: application/json

{
  "status": "SUCCESS"
}
```

**Status Options:** `PENDING` or `SUCCESS`

**Response:** Full updated order object

### Create Return Request (Customer)
```bash
POST http://localhost:3000/api/order/return
Authorization: Bearer <your_customer_jwt_token>
Content-Type: application/json

{
  "orderId": 1,
  "items": [
    {
      "productId": 1,
      "qty": 1
    }
  ]
}
```

### Update Return Status (Admin Only)
```bash
POST http://localhost:3000/api/order/return/1/status
Authorization: Bearer <your_admin_jwt_token>
Content-Type: application/json

{
  "status": "REFUND"
}
```

**Status Options:** `PENDING`, `PICKED`, or `REFUND`

**Important:** When status is updated to `REFUND`, a CREDIT transaction is automatically created!

---

## üö® Error Handling

### Unauthorized (Missing Token)
```
401 Unauthorized
{
  "message": "Unauthorized",
  "statusCode": 401
}
```

### Forbidden (Insufficient Permissions)
```
403 Forbidden
{
  "message": "Forbidden",
  "statusCode": 403
}
```

Example: If a CUSTOMER tries to call an ADMIN-only route.

### Validation Error
```
400 Bad Request
{
  "message": "Validation failed",
  "errors": [...]
}
```

---

## üìä Testing Checklist

- [ ] **Authentication**
  - [ ] Register ADMIN user
  - [ ] Register CUSTOMER user
  - [ ] Login and receive JWT token
  - [ ] Use token in subsequent requests

- [ ] **User Management**
  - [ ] GET /user with pagination
  - [ ] GET /user with sortBy
  - [ ] GET /user with field selection
  - [ ] GET /user/:id
  - [ ] PATCH /user/:id

- [ ] **Products**
  - [ ] GET /product with pagination
  - [ ] GET /product with sorting
  - [ ] GET /product with field selection
  - [ ] GET /product/:id

- [ ] **Orders**
  - [ ] POST /order (create order)
  - [ ] GET /order (paginated, user-specific)
  - [ ] GET /order with sorting
  - [ ] GET /order with field selection
  - [ ] GET /order/:id
  - [ ] POST /order/return (create return)

- [ ] **Admin Actions**
  - [ ] POST /order/:id/status (admin only)
  - [ ] POST /order/return/:returnId/status (admin only)
  - [ ] Verify CREDIT transaction on REFUND

- [ ] **Transactions**
  - [ ] GET /transaction (paginated)
  - [ ] GET /transaction with sorting
  - [ ] GET /transaction with field selection

- [ ] **Security**
  - [ ] Admin routes reject non-admin users
  - [ ] User routes require valid JWT
  - [ ] Public routes work without token

---

## üêõ Troubleshooting

### Database Connection Error
```
PrismaClientInitializationError: Authentication failed
```
**Fix:** Ensure MySQL is running and credentials in `.env` are correct

### JWT Secret Not Found
```
TypeError: Configuration key "JWT_SECRET" does not exist
```
**Fix:** Ensure `.env` file exists and has JWT_SECRET defined

### Token Invalid
```
401 Unauthorized
```
**Fix:** 
- Token might be expired
- Token might be malformed
- Token not included in Authorization header
- Use format: `Authorization: Bearer <token>`

### Role Validation Failed
```
403 Forbidden
```
**Fix:** User doesn't have required role for the endpoint

---

## üìù Using Postman or Thunder Client

1. Import these environment variables:
   ```
   {
     "base_url": "http://localhost:3000",
     "admin_token": "<token_from_admin_login>",
     "customer_token": "<token_from_customer_login>"
   }
   ```

2. Use in requests:
   ```
   {{base_url}}/order
   Authorization: Bearer {{admin_token}}
   ```

3. Create a collection with folders:
   - Auth
   - Users
   - Products
   - Orders
   - Transactions
   - Admin Actions

---

**Happy Testing! üöÄ**
